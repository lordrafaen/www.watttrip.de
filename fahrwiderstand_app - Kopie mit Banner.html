
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fahrwiderstands- & Verbrauchsrechner (EV & Verbrenner)</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --accent:#22d3ee; --accent-2:#a78bfa;
      --text:#e5e7eb; --muted:#94a3b8; --ev:#06b6d4; --ice:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:24px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
      background:radial-gradient(1200px 600px at 10% 10%,#0b1220 0%,var(--bg) 35%,#0b1220 100%);
      color:var(--text)
    }
    h1{margin:0 0 12px;font-size:1.6rem;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(34,211,238,.1);
           color:var(--accent);border:1px solid rgba(34,211,238,.25);font-size:.8rem}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#0b1220;color:#dbeafe;border:1px solid #334155;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{border-color:#22d3ee;color:#22d3ee}
    .select{background:#0b1220;color:#dbeafe;border:1px solid #334155;padding:8px 10px;border-radius:8px}
    .layout{
      display:grid;
      grid-template-columns: 1.2fr 1fr 140px; /* rechts schmale Banner-Spalte */
      gap:16px;
    }
    @media (max-width:1200px){ .layout{ grid-template-columns:1fr } .ads{ display:none } }
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(34,211,238,.08),0 10px 30px rgba(0,0,0,.35)}
    .inputs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .inputs .wide{grid-column:1/-1}
    label{display:block;font-size:.88rem;color:var(--muted);margin-bottom:6px}
    input[type="number"], select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:var(--text);
      outline:none;box-shadow:inset 0 0 0 1px rgba(167,139,250,.15)
    }
    input[type="number"]:focus, select:focus{border-color:#22d3ee;box-shadow:0 0 0 2px rgba(34,211,238,.25)}
    .kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:#0b1220;border:1px dashed #334155;padding:12px;border-radius:10px}
    .kpi .label{font-size:.78rem;color:var(--muted)}
    .kpi .value{font-size:1.1rem;font-variant-numeric:tabular-nums}
    .cons-box{margin-bottom:10px;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220}
    .cons-title{font-size:.92rem;margin-bottom:6px;color:#cbd5e1}
    .cons-value{font-size:1.6rem;font-weight:700;letter-spacing:.2px}
    .cons-ev{color:var(--ev)} .cons-ice{color:var(--ice)}
    .cons-sub{font-size:.82rem;color:#9aa9bb;margin-top:4px}
    canvas{width:100%;height:380px;background:#0b1220;border-radius:12px;border:1px solid #334155}
    .footer{margin-top:10px;font-size:.8rem;color:var(--muted)}
    .two-col{display:flex;gap:6px} .two-col>div{flex:1}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid #374151;margin-left:6px}
    .ads{display:flex;flex-direction:column;gap:16px}
    .ads .ad{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:8px;text-align:center}
  </style>
</head>
<body>
  <h1>
    <span id="title">Fahrwiderstands‚Äë & Verbrauchsrechner</span>
    <span class="toolbar">
      <select id="langSel" class="select" title="Language">
        <option value="auto">üåê Auto</option>
        <option value="zh">‰∏≠Êñá (ÁÆÄ‰Ωì)</option>
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="pt">Portugu√™s</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="de">Deutsch</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
      </select>
      <button class="btn" id="exportBtn" title="HTML als Base64-Data-URI kopieren">Export (Base64‚ÄëData‚ÄëURI)</button>
      <span class="badge" id="badge">EV &amp; ICE</span>
    </span>
  </h1>

  <div class="layout">
    <!-- Eingaben -->
    <div class="card">
      <div class="inputs">
        <div class="wide">
          <label id="lblKlasse">Fahrzeugklasse (Voreinstellungen)</label>
          <select id="klasse">
            <option value="kompakt">Kompaktklasse (EV) ‚Äì Standard</option>
            <option value="klein">Kleinwagen (EV)</option>
            <option value="mittel">Mittelklasse (EV)</option>
            <option value="suv">SUV (EV)</option>
            <option value="transporter">Transporter (EV)</option>
            <option value="sport">Sportwagen (EV)</option>
            <option value="custom">Benutzerdefiniert</option>
          </select>
        </div>

        <div>
          <label id="lblAntriebsart">Antriebsart / Kraftstoff</label>
          <select id="antriebArt">
            <option value="ev">Elektrofahrzeug</option>
            <option value="benzin">Verbrenner ‚Äì Benzin</option>
            <option value="diesel">Verbrenner ‚Äì Diesel</option>
          </select>
        </div>

        <div>
          <label id="lblDrivetrain">Antriebskonfiguration</label>
          <select id="drivetrain">
            <option value="2wd">2WD (Œ∑ = 0,92)</option>
            <option value="4wd">4WD (Œ∑ = 0,88)</option>
          </select>
        </div>

        <div>
          <label id="lblCw">cw‚ÄëWert</label>
          <input type="number" id="cw" step="0.01" min="0.1" max="1.0" />
        </div>

        <div>
          <label id="lblA">Stirnfl√§che A [m¬≤]</label>
          <input type="number" id="A" step="0.01" min="1.0" max="5.0" />
        </div>

        <div>
          <label id="lblV">Geschwindigkeit v [km/h]</label>
          <input type="number" id="v" step="1" min="1" max="300" />
        </div>

        <div>
          <label id="lblVmax">H√∂chstgeschwindigkeit [km/h]</label>
          <input type="number" id="vmax" step="1" min="80" max="300" />
        </div>

        <div>
          <label id="lblMleer">Fahrzeugmasse leer [kg]</label>
          <input type="number" id="mLeer" step="10" min="500" max="4000" />
        </div>

        <div>
          <label id="lblNpers">Anzahl Personen</label>
          <input type="number" id="nPers" step="1" min="0" max="9" />
        </div>

        <div>
          <label id="lblStyle">Fahrweise (Stil‚ÄëFaktor)</label>
          <select id="fStyle">
            <option value="1.00">Eco / Ruhig (√ó1,00)</option>
            <option value="1.10">Normal (√ó1,10)</option>
            <option value="1.25">Sportlich (√ó1,25)</option>
          </select>
        </div>

        <div>
          <label id="lblTraffic">Verkehrssituation (Verbrauchsfaktor)</label>
          <select id="fTraffic">
            <option value="1.00">freie Fahrt (Urlaubsfahrt) ‚Äì √ó1,00</option>
            <option value="1.05">wenig Verkehr ‚Äì √ó1,05</option>
            <option value="1.15">mittlerer Verkehr ‚Äì √ó1,15</option>
            <option value="1.35">hoher Verkehr ‚Äì √ó1,35</option>
            <option value="1.70">Stau / Stop‚Äëand‚ÄëGo ‚Äì √ó1,70</option>
          </select>
        </div>
      </div>
      <p class="footer" id="hintTraffic">
        Verkehrsfaktor ist eine grobe pauschale Korrektur f√ºr Stop‚Äëand‚ÄëGo, Brems‚Äë/Beschleunigungsanteil, Tempowechsel etc. Die Fahrweise wirkt zus√§tzlich als Stil‚ÄëFaktor.
      </p>
    </div>

    <!-- Ergebnisse & Diagramm -->
    <div class="card">
      <!-- Deutlich hervorgehobener Verbrauch -->
      <div class="cons-box">
        <div id="consEV" style="display:none;">
          <div class="cons-title" id="evTitle">Verbrauch (EV, mit Verkehr + Fahrweise)</div>
          <div class="cons-value cons-ev" id="evConsCorr">‚Äì</div>
          <div class="cons-sub">
            <span id="evBaseLabel">Basis ohne Faktoren:</span> <span id="evConsBase">‚Äì</span><br/>
            <span id="evFuelEqLabel">Kraftstoff‚Äë√Ñquivalent (Œ∑=18%):</span>
            Benzin <span id="evAsBenzin">‚Äì</span> ¬∑ Diesel <span id="evAsDiesel">‚Äì</span>
          </div>
        </div>
        <div id="consICE" style="display:none;">
          <div class="cons-title" id="iceTitle">Verbrauch (mit Verkehr + Fahrweise)</div>
          <div class="cons-value cons-ice" id="iceConsCorr">‚Äì</div>
          <div class="cons-sub">
            <span id="iceEvEqLabel">EV‚Äë√Ñquivalent (mit Faktoren):</span> <span id="iceAsEV">‚Äì</span><br/>
            <span id="iceBaseText">Basis ohne Faktoren:</span> <span id="iceConsBase">‚Äì</span>
            ¬∑ <span id="iceChemLabel">chemisch:</span> <span id="iceChemCorr">‚Äì</span>
          </div>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="label" id="kpiMass">Gesamtmasse m<sub>gesamt</sub> [kg]</div><div class="value" id="mGesOut">‚Äì</div></div>
        <div class="kpi"><div class="label" id="kpiAir">Luftwiderstand F<sub>Luft</sub> [N]</div><div class="value" id="fLuftOut">‚Äì</div></div>
        <div class="kpi"><div class="label" id="kpiRoll">Rollwiderstand F<sub>Roll</sub> [N]</div><div class="value" id="fRollOut">‚Äì</div></div>
        <div class="kpi"><div class="label" id="kpiTotal">Gesamt F<sub>ges</sub> [N]</div><div class="value" id="fGesOut">‚Äì</div></div>
        <div class="kpi"><div class="label" id="kpiPrad">Radleistung P<sub>Rad</sub> [kW]</div><div class="value" id="pRadOut">‚Äì</div></div>
        <div class="kpi"><div class="label" id="kpiPmot">Motorleistung P<sub>Motor</sub> [kW]</div><div class="value" id="pMotorOut">‚Äì</div></div>
      </div>

      <div style="margin-top:12px;">
        <div class="two-col">
          <div>
            <span class="pill" id="bpText">Betriebspunkt: ‚Äì</span>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <canvas id="chart" width="800" height="380"></canvas>
      </div>

      <div class="footer">
        <p id="footEV">EV: Berechnung ber√ºcksichtigt nur Fahrwiderst√§nde und Antriebsstrangverluste (keine Nebenverbraucher, Rekuperation, Temperatur etc.).</p>
        <p id="footICE">Verbrenner: Berechnung basiert auf pauschalem Wirkungsgrad Œ∑ = 18 % (grobe N√§herung). Verkehrsfaktoren sind pauschale Sch√§tzwerte und ersetzen keine detaillierte Fahrprofil‚ÄëSimulation.</p>
      </div>
    </div>

    <!-- Banner-Spalte (rechts) -->
    <div class="ads">
      <div class="ad">
        <!-- Skyscraper 120x600 -->
        https://a.check24.net/misc/click.php?pid=194868&amp;aid=301&amp;deep=stromanbieter-wechseln&amp;cat=1
          https://a.check24.net/misc/view.php?pid=194868&amp;aid=301&amp;cat=1
        </a>
      </div>
      <div class="ad">
        <!-- Banner 120x60 -->
        https://a.check24.net/misc/click.php?pid=194868&amp;aid=274&amp;deep=mietwagen-preisvergleich&amp;cat=10
          https://a.check24.net/misc/view.php?pid=194868&amp;aid=274&amp;cat=10
        </a>
      </div>
    </div>
  </div>

  <script>
    /* ===================== I18N: Sprachpakete (Deutsch = Standard) ===================== */
    const I18N = {
      de: {
        ui:{title:"Fahrwiderstands‚Äë & Verbrauchsrechner", badge:"EV & ICE", export:"Export (Base64‚ÄëData‚ÄëURI)", copied:"Kopiert ‚úì", copyFail:"Kopieren fehlgeschlagen. Data‚ÄëURI wird angezeigt:\n"},
        class:{label:"Fahrzeugklasse (Voreinstellungen)", small:"Kleinwagen (EV)", compact:"Kompaktklasse (EV) ‚Äì Standard", mid:"Mittelklasse (EV)", suv:"SUV (EV)", van:"Transporter (EV)", sport:"Sportwagen (EV)", custom:"Benutzerdefiniert"},
        drivetype:{label:"Antriebsart / Kraftstoff", ev:"Elektrofahrzeug", gas:"Verbrenner ‚Äì Benzin", diesel:"Verbrenner ‚Äì Diesel"},
        drivetrain:{label:"Antriebskonfiguration", "2wd":"2WD (Œ∑ = 0,92)","4wd":"4WD (Œ∑ = 0,88)"},
        fields:{
          cw:"cw‚ÄëWert", area:"Stirnfl√§che A [m¬≤]", v:"Geschwindigkeit v [km/h]", vmax:"H√∂chstgeschwindigkeit [km/h]",
          m:"Fahrzeugmasse leer [kg]", n:"Anzahl Personen", style:"Fahrweise (Stil‚ÄëFaktor)", traffic:"Verkehrssituation (Verbrauchsfaktor)"
        },
        style:{eco:"Eco / Ruhig (√ó1,00)", normal:"Normal (√ó1,10)", sport:"Sportlich (√ó1,25)"},
        traffic:{hint:"Verkehrsfaktor ist eine grobe pauschale Korrektur f√ºr Stop‚Äëand‚ÄëGo, Brems‚Äë/Beschleunigungsanteil, Tempowechsel etc. Die Fahrweise wirkt zus√§tzlich als Stil‚ÄëFaktor.",
                 free:"freie Fahrt (Urlaubsfahrt) ‚Äì √ó1,00", low:"wenig Verkehr ‚Äì √ó1,05", mid:"mittlerer Verkehr ‚Äì √ó1,15", high:"hoher Verkehr ‚Äì √ó1,35", jam:"Stau / Stop‚Äëand‚ÄëGo ‚Äì √ó1,70"},
        kpi:{mass:"Gesamtmasse m\u209F [kg]", air:"Luftwiderstand F\u2097 [N]", roll:"Rollwiderstand F\u209A [N]", total:"Gesamt F\u2091 [N]", prad:"Radleistung P\u209A [kW]", pmot:"Motorleistung P\u2098 [kW]"},
        cons:{
          evTitle:"Verbrauch (EV, mit Verkehr + Fahrweise)", evBase:"Basis ohne Faktoren:", fuelEq:"Kraftstoff‚Äë√Ñquivalent (Œ∑=18%):",
          iceTitle:"Verbrauch (mit Verkehr + Fahrweise)", iceBase:"Basis ohne Faktoren:", chem:"chemisch:", evEq:"EV‚Äë√Ñquivalent (mit Faktoren):"
        },
        bp:(v,p)=>`Betriebspunkt: ${v} km/h ‚Äî P = ${p} kW`,
        chart:{x:"Geschwindigkeit v [km/h]", y:"Motorleistung P [kW]", tip:(v,p)=>`v=${v} km/h, P=${p} kW`},
        foot:{ev:"EV: Berechnung ber√ºcksichtigt nur Fahrwiderst√§nde und Antriebsstrangverluste (keine Nebenverbraucher, Rekuperation, Temperatur etc.).",
              ice:"Verbrenner: Berechnung basiert auf pauschalem Wirkungsgrad Œ∑ = 18 % (grobe N√§herung). Verkehrsfaktoren sind pauschale Sch√§tzwerte und ersetzen keine detaillierte Fahrprofil‚ÄëSimulation."},
        units:{kWh100:"kWh/100 km", l100:"l/100 km", chem:"kWh/100 km"}
      },
      /* ‚Ä¶ (weitere Sprachen wie zuvor; zur K√ºrze hier weggelassen ‚Äì gleiche Struktur wie vorher) ‚Ä¶ */
    };

    const LOCALE_MAP = { de:"de-DE", en:"en-US", es:"es-ES", hi:"hi-IN", bn:"bn-BD", pt:"pt-PT", ru:"ru-RU", ja:"ja-JP", ko:"ko-KR", zh:"zh-CN" };
    const RTL = new Set([]); // keine RTL-Sprachen in der aktuellen Auswahl

    /* ===================== Physik-Konstanten & Presets ===================== */
    const rho = 1.225, c_r = 0.012, g = 9.81;
    const eta_2wd = 0.92, eta_4wd = 0.88, eta_ice = 0.18;
    const hv_benzin = 8.9, hv_diesel = 9.8;

    const presets = {
      klein:      { cw:0.32, A:2.05, m:1400, dt:'2wd', vmax:150 },
      kompakt:    { cw:0.29, A:2.20, m:1700, dt:'2wd', vmax:160 },
      mittel:     { cw:0.28, A:2.30, m:1900, dt:'2wd', vmax:180 },
      suv:        { cw:0.30, A:2.70, m:2200, dt:'4wd', vmax:180 },
      transporter:{ cw:0.42, A:3.10, m:2600, dt:'2wd', vmax:140 },
      sport:      { cw:0.25, A:2.00, m:1900, dt:'2wd', vmax:250 },
      custom: null
    };

    /* ===================== DOM Refs ===================== */
    const el = {
      title:document.getElementById('title'), badge:document.getElementById('badge'),
      exportBtn:document.getElementById('exportBtn'), langSel:document.getElementById('langSel'),
      // inputs
      klasse:document.getElementById('klasse'), antriebArt:document.getElementById('antriebArt'),
      drivetrain:document.getElementById('drivetrain'), cw:document.getElementById('cw'), A:document.getElementById('A'),
      v:document.getElementById('v'), vmax:document.getElementById('vmax'), mLeer:document.getElementById('mLeer'),
      nPers:document.getElementById('nPers'), fStyle:document.getElementById('fStyle'), fTraffic:document.getElementById('fTraffic'),
      // labels
      lblKlasse:document.getElementById('lblKlasse'), lblAntriebsart:document.getElementById('lblAntriebsart'),
      lblDrivetrain:document.getElementById('lblDrivetrain'), lblCw:document.getElementById('lblCw'), lblA:document.getElementById('lblA'),
      lblV:document.getElementById('lblV'), lblVmax:document.getElementById('lblVmax'), lblMleer:document.getElementById('lblMleer'),
      lblNpers:document.getElementById('lblNpers'), lblStyle:document.getElementById('lblStyle'), lblTraffic:document.getElementById('lblTraffic'),
      hintTraffic:document.getElementById('hintTraffic'),
      // outputs
      mGesOut:document.getElementById('mGesOut'), fLuftOut:document.getElementById('fLuftOut'),
      fRollOut:document.getElementById('fRollOut'), fGesOut:document.getElementById('fGesOut'),
      pRadOut:document.getElementById('pRadOut'), pMotorOut:document.getElementById('pMotorOut'),
      consEV:document.getElementById('consEV'), evConsCorr:document.getElementById('evConsCorr'),
      evConsBase:document.getElementById('evConsBase'), evTitle:document.getElementById('evTitle'),
      evBaseLabel:document.getElementById('evBaseLabel'), evFuelEqLabel:document.getElementById('evFuelEqLabel'),
      evAsBenzin:document.getElementById('evAsBenzin'), evAsDiesel:document.getElementById('evAsDiesel'),
      consICE:document.getElementById('consICE'), iceConsCorr:document.getElementById('iceConsCorr'),
      iceChemCorr:document.getElementById('iceChemCorr'), iceConsBase:document.getElementById('iceConsBase'),
      iceTitle:document.getElementById('iceTitle'), iceBaseText:document.getElementById('iceBaseText'),
      iceChemLabel:document.getElementById('iceChemLabel'), iceAsEV:document.getElementById('iceAsEV'),
      bpText:document.getElementById('bpText'), chart:document.getElementById('chart'),
      kpiMass:document.getElementById('kpiMass'), kpiAir:document.getElementById('kpiAir'), kpiRoll:document.getElementById('kpiRoll'),
      kpiTotal:document.getElementById('kpiTotal'), kpiPrad:document.getElementById('kpiPrad'), kpiPmot:document.getElementById('kpiPmot'),
      footEV:document.getElementById('footEV'), footICE:document.getElementById('footICE')
    };

    /* ===================== Sprache / i18n Logik ===================== */
    let currentLang = 'de';

    function detectLanguage(){
      try{
        const nav = (navigator.language || navigator.userLanguage || 'de').toLowerCase();
        const short = nav.split('-')[0];
        const supported = new Set(Object.keys(I18N));
        // erkannte Sprache, sonst Fallback Deutsch
        return supported.has(short) ? short : 'de';
      } catch(_){ return 'de'; }
    }

    function format(x, d=2){
      if (!isFinite(x)) return '‚Äì';
      const nfLocal = new Intl.NumberFormat(LOCALE_MAP[currentLang] || 'de-DE', {maximumFractionDigits:d, minimumFractionDigits:d});
      return nfLocal.format(x);
    }

    function applyI18N(lang){
      currentLang = lang || 'de';
      const L = I18N[currentLang] || I18N['de'];
      document.documentElement.lang = currentLang;
      document.documentElement.dir = RTL.has(currentLang) ? 'rtl' : 'ltr';

      // Top UI
      el.title.textContent = L.ui.title;
      el.badge.textContent = L.ui.badge;
      el.exportBtn.textContent = L.ui.export;

      // Labels & Options
      el.lblKlasse.textContent = L.class.label;
      setOptionText(el.klasse, {klein:L.class.small, kompakt:L.class.compact, mittel:L.class.mid, suv:L.class.suv, transporter:L.class.van, sport:L.class.sport, custom:L.class.custom});

      el.lblAntriebsart.textContent = L.drivetype.label;
      setOptionText(el.antriebArt, {ev:L.drivetype.ev, benzin:L.drivetype.gas, diesel:L.drivetype.diesel});

      el.lblDrivetrain.textContent = L.drivetrain.label;
      setOptionText(el.drivetrain, {'2wd':L.drivetrain['2wd'], '4wd':L.drivetrain['4wd']});

      el.lblCw.textContent = L.fields.cw;
      el.lblA.textContent = L.fields.area;
      el.lblV.textContent = L.fields.v;
      el.lblVmax.textContent = L.fields.vmax;
      el.lblMleer.textContent = L.fields.m;
      el.lblNpers.textContent = L.fields.n;
      el.lblStyle.textContent = L.fields.style;
      setOptionText(el.fStyle, {"1.00":L.style.eco,"1.10":L.style.normal,"1.25":L.style.sport});
      el.lblTraffic.textContent = L.fields.traffic;
      el.hintTraffic.textContent = L.traffic.hint;
      setOptionText(el.fTraffic, {"1.00":L.traffic.free,"1.05":L.traffic.low,"1.15":L.traffic.mid,"1.35":L.traffic.high,"1.70":L.traffic.jam});

      // KPIs
      el.kpiMass.innerHTML = "Gesamtmasse m<sub>gesamt</sub> [kg]"; // f√ºr DE explizit
      el.kpiAir.innerHTML = L.kpi.air;
      el.kpiRoll.innerHTML = L.kpi.roll;
      el.kpiTotal.innerHTML = L.kpi.total;
      el.kpiPrad.innerHTML = L.kpi.prad;
      el.kpiPmot.innerHTML = L.kpi.pmot;

      // Consumption boxes
      el.evTitle.textContent = L.cons.evTitle;
      el.evBaseLabel.textContent = L.cons.evBase;
      el.evFuelEqLabel.textContent = L.cons.fuelEq;
      el.iceTitle.textContent = L.cons.iceTitle;
      el.iceBaseText.textContent = L.cons.iceBase;
      el.iceChemLabel.textContent = L.cons.chem;

      // Footer
      el.footEV.textContent = L.foot.ev;
      el.footICE.textContent = L.foot.ice;

      updateBpText();
    }

    function setOptionText(selectEl, mapByValue){
      [...selectEl.options].forEach(opt=>{
        const k = opt.value;
        if (mapByValue[k]) opt.textContent = mapByValue[k];
      });
    }

    /* ===================== Berechnung & Diagramm ===================== */
    let lastCompute = {cw:0,A:0,mLeer:0,nPers:0,eta_dt:0,vmax:200,v_kmh:100};

    function drivetrainEta(){ return el.drivetrain.value === '4wd' ? eta_4wd : eta_2wd; }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function setPreset(name){
      const p = presets[name]; if (!p) return;
      el.cw.value = p.cw; el.A.value = p.A; el.mLeer.value = p.m; el.drivetrain.value = p.dt; el.vmax.value = p.vmax;
      if (!el.v.value) el.v.value = Math.min(100, p.vmax);
      compute();
    }

    function compute(){
      const cw = parseFloat(el.cw.value);
      const A = parseFloat(el.A.value);
      const v_kmh = clamp(parseFloat(el.v.value), 1, 300);
      const v_ms = v_kmh / 3.6;
      const vmax = clamp(parseFloat(el.vmax.value), 80, 300);
      const mLeer = parseFloat(el.mLeer.value);
      const nPers = parseInt(el.nPers.value || 0);
      const eta_dt = drivetrainEta();
      const fTraffic = parseFloat(el.fTraffic.value);
      const fStyle = parseFloat(el.fStyle.value);

      const mGes = mLeer + 80 * nPers;
      const fLuft = 0.5 * rho * cw * A * v_ms * v_ms;
      const fRoll = c_r * mGes * g;
      const fGes = fLuft + fRoll;

      const pRad_kW = fGes * v_ms / 1000.0;
      const pMotor_kW = pRad_kW / eta_dt;

      const t_100_h = 100.0 / v_kmh;
      const e100_base_kWh = pMotor_kW * t_100_h;

      const factorTotal = fTraffic * fStyle;

      // Ausgabe
      el.mGesOut.textContent = format(mGes,0);
      el.fLuftOut.textContent = format(fLuft);
      el.fRollOut.textContent = format(fRoll);
      el.fGesOut.textContent = format(fGes);
      el.pRadOut.textContent = format(pRad_kW);
      el.pMotorOut.textContent = format(pMotor_kW);

      const L = I18N[currentLang] || I18N['de'];
      if (el.antriebArt.value === 'ev'){
        el.consICE.style.display = 'none';
        el.consEV.style.display = 'block';
        const e100_corr = e100_base_kWh * factorTotal;
        el.evConsBase.textContent = `${format(e100_base_kWh)} ${L.units.kWh100}`;
        el.evConsCorr.textContent = `${format(e100_corr)} ${L.units.kWh100}`;

        const eChem_corr = e100_corr / eta_ice;
        const l100_benzin = eChem_corr / hv_benzin;
        const l100_diesel = eChem_corr / hv_diesel;
        el.evAsBenzin.textContent = `${format(l100_benzin)} ${L.units.l100}`;
        el.evAsDiesel.textContent = `${format(l100_diesel)} ${L.units.l100}`;
      } else {
        el.consEV.style.display = 'none';
        el.consICE.style.display = 'block';

        const hv = (el.antriebArt.value === 'benzin') ? hv_benzin : hv_diesel;
        const eChem_base = e100_base_kWh / eta_ice;
        const l100_base  = eChem_base / hv;
        const eChem_corr = eChem_base * factorTotal;
        const l100_corr  = l100_base  * factorTotal;

        el.iceConsBase.textContent = `${format(l100_base)} ${L.units.l100}`;
        el.iceChemCorr.textContent = `${format(eChem_corr)} ${L.units.chem}`;
        el.iceConsCorr.textContent = `${format(l100_corr)} ${L.units.l100}`;

        const e100_corr = e100_base_kWh * factorTotal;
        el.iceAsEV.textContent = `${format(e100_corr)} ${L.units.kWh100}`;
      }

      lastCompute = {cw,A,mLeer,nPers,eta_dt,vmax,v_kmh};
      updateBpText();
      drawChart(cw, A, mLeer, nPers, eta_dt, vmax, v_kmh);
    }

    function updateBpText(){
      const L = I18N[currentLang] || I18N['de'];
      const v_kmh = lastCompute.v_kmh;
      const v_ms  = v_kmh/3.6;
      const fLuft = 0.5*rho*lastCompute.cw*lastCompute.A*v_ms*v_ms;
      const fRoll = c_r*(lastCompute.mLeer+80*lastCompute.nPers)*g;
      const pMotor = (fLuft+fRoll)*v_ms/1000.0/(lastCompute.eta_dt || eta_2wd);
      el.bpText.textContent = L.bp(format(v_kmh,0), format(pMotor));
    }

    function drawChart(cw, A, mLeer, nPers, eta_dt, vmax, v_kmh){
      const canvas = el.chart;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const pad = {left:60,right:20,top:20,bottom:40};
      const w = canvas.width - pad.left - pad.right;
      const h = canvas.height - pad.top - pad.bottom;

      const mGes = mLeer + 80*nPers;
      const N = Math.max(60, Math.floor(vmax));
      const xs=[], ys=[]; let yMax = 0;

      for(let i=0;i<=N;i++){
        const v_kmh_i = i*(vmax/N), v_ms_i = v_kmh_i/3.6;
        const fLuft_i = 0.5*rho*cw*A*v_ms_i*v_ms_i;
        const fRoll_i = c_r*mGes*g;
        const pMotor_i = (fLuft_i + fRoll_i)*v_ms_i/1000.0/(eta_dt || eta_2wd);
        xs.push(v_kmh_i); ys.push(pMotor_i); if (pMotor_i>yMax) yMax=pMotor_i;
      }
      yMax = Math.max(yMax,20)*1.10;

      function xToPx(x){ return pad.left + (x/vmax)*w; }
      function yToPx(y){ return pad.top + h - (y/yMax)*h; }

      // Grid
      ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
      ctx.beginPath();
      const gridX=10, gridY=8;
      for(let gx=0;gx<=gridX;gx++){ const x=pad.left+(gx/gridX)*w; ctx.moveTo(x,pad.top); ctx.lineTo(x,pad.top+h); }
      for(let gy=0;gy<=gridY;gy++){ const y=pad.top+(gy/gridY)*h; ctx.moveTo(pad.left,y); ctx.lineTo(pad.left+w,y); }
      ctx.stroke();

      // Axes
      ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(pad.left,pad.top+h); ctx.lineTo(pad.left+w,pad.top+h);
      ctx.moveTo(pad.left,pad.top); ctx.lineTo(pad.left,pad.top+h);
      ctx.stroke();

      // Labels
      const L = I18N[currentLang] || I18N['de'];
      ctx.fillStyle = '#94a3b8'; ctx.font = '12px system-ui';
      ctx.fillText(L.chart.x, pad.left + w/2 - 70, pad.top + h + 28);
      ctx.save(); ctx.translate(16, pad.top + h/2 + 40); ctx.rotate(-Math.PI/2);
      ctx.fillText(L.chart.y, 0, 0); ctx.restore();

      // Ticks
      ctx.fillStyle = '#cbd5e1'; ctx.font = '11px system-ui';
      for (let gx=0; gx<=10; gx++){
        const xVal = Math.round((gx/10) * vmax);
        ctx.fillText(String(xVal), xToPx(xVal)-8, pad.top+h+16);
      }
      for (let gy=0; gy<=8; gy++){
        const yVal = Math.round((gy/8) * yMax);
        ctx.fillText(String(yVal), pad.left-40, yToPx(yVal)+4);
      }

      // Curve
      ctx.strokeStyle = 'rgba(34,211,238,0.9)'; ctx.lineWidth = 2.2;
      ctx.beginPath();
      for (let i=0;i<xs.length;i++) {
        const x = xToPx(xs[i]), y = yToPx(ys[i]);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // Betriebspunkt
      const v_ms = v_kmh/3.6;
      const fLuft = 0.5*rho*cw*A*v_ms*v_ms;
      const fRoll = c_r*(mLeer+80*nPers)*g;
      const pMotor = (fLuft+fRoll)*v_ms/1000.0/(eta_dt || eta_2wd);
      const xPt = xToPx(v_kmh), yPt = yToPx(pMotor);

      ctx.fillStyle = '#a78bfa'; ctx.strokeStyle = '#a78bfa';
      ctx.beginPath(); ctx.arc(xPt,yPt,4.5,0,Math.PI*2); ctx.fill();
      ctx.setLineDash([4,4]); ctx.lineWidth = 1.2;
      ctx.beginPath(); ctx.moveTo(xPt,pad.top+h); ctx.lineTo(xPt,yPt); ctx.moveTo(pad.left,yPt); ctx.lineTo(xPt,yPt); ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = '#dbeafe'; ctx.font = '12px system-ui';
      ctx.fillText(L.chart.tip(Math.round(v_kmh), pMotor.toFixed(1)), Math.min(xPt+10, pad.left+w-140), Math.max(yPt-10, pad.top+16));
    }

    /* ===================== Events & Export ===================== */
    ['input','change'].forEach(evt=>{
      ['klasse','antriebArt','drivetrain','cw','A','v','vmax','mLeer','nPers','fStyle','fTraffic']
        .forEach(id => document.getElementById(id).addEventListener(evt, compute));
    });
    document.getElementById('klasse').addEventListener('change', ()=> setPreset(document.getElementById('klasse').value));

    // Export Base64
    el.exportBtn.addEventListener('click', ()=>{
      const L = I18N[currentLang] || I18N['de'];
      const html = '<!DOCTYPE html>' + document.documentElement.outerHTML;
      const base64 = btoa(unescape(encodeURIComponent(html)));
      const uri = 'data:text/html;base64,' + base64;
      navigator.clipboard.writeText(uri).then(()=>{
        el.exportBtn.textContent = L.ui.copied;
        setTimeout(()=> el.exportBtn.textContent = L.ui.export, 1500);
      }).catch(()=> alert(L.ui.copyFail + uri));
    });

    // Sprache: Auto/Manuell (Standard: DE, bei Auto wird erkannt ‚Äì Fallback DE)
    el.langSel.addEventListener('change', ()=>{
      const val = el.langSel.value;
      const lang = (val === 'auto') ? detectLanguage() : val;
      applyI18N(lang);
      compute();
    });

    // ===== INIT: Deutsch als Start, dann Auto-Erkennung mit Fallback DE, danach Bef√ºllung =====
    function init(){
      // 1) Sprache einstellen
      const detected = detectLanguage();        // liefert 'de' wenn unbekannt
      applyI18N(detected);                      // setzt UI-Strings, Badge etc.
      el.langSel.value = 'auto';                // zeigt Auto im Dropdown

      // 2) Defaults (wie Vorg√§ngerversion)
      el.klasse.value = 'kompakt';
      el.antriebArt.value = 'ev';
      el.nPers.value = 1;
      el.v.value = 100;
      el.fTraffic.value = '1.00';
      el.fStyle.value = '1.10';

      // 3) Preset anwenden und rechnen
      setPreset('kompakt'); // ruft compute()
      compute();            // Safety: falls Preset schon gerechnet hat, bleibt konsistent
    }
    // Starte init sofort
    init();
  </script>
</body>
</html>
