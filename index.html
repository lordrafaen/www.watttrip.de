<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fahrwiderstands- & Verbrauchsrechner (EV & Verbrenner)</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --accent:#22d3ee; --accent2:#a78bfa;
      --text:#e5e7eb; --muted:#94a3b8; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:24px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
      background:radial-gradient(1200px 600px at 10% 10%,#0b1220 0%,var(--bg) 35%,#0b1220 100%);
      color:var(--text)
    }
    h1{margin:0 0 12px;font-size:1.6rem;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .titlewrap{display:flex;align-items:center;gap:12px}
    .brand{display:flex;flex-direction:column;align-items:center;line-height:1}
    .brand svg{width:44px;height:44px;opacity:.55}
    .brand .brandcaption{margin-top:4px;font-size:.72rem;color:var(--muted);white-space:nowrap}
    .title{font-weight:700}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(34,211,238,.1);
           color:var(--accent);border:1px solid rgba(34,211,238,.25);font-size:.8rem}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#0b1220;color:#dbeafe;border:1px solid #334155;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{border-color:#22d3ee;color:#22d3ee}
    .layout{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media (max-width:1200px){ .layout{ grid-template-columns:1fr } }
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:16px;
          box-shadow:0 0 0 1px rgba(34,211,238,.08),0 10px 30px rgba(0,0,0,.35)}
    .inputs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .inputs .wide{grid-column:1/-1}
    label{display:block;font-size:.88rem;color:var(--muted);margin-bottom:6px}
    input[type="number"], select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:var(--text);
      outline:none;box-shadow:inset 0 0 0 1px rgba(167,139,250,.15)
    }
    input[type="number"]:focus, select:focus{border-color:#22d3ee;box-shadow:0 0 0 2px rgba(34,211,238,.25)}
    .kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:#0b1220;border:1px dashed #334155;padding:12px;border-radius:10px}
    .kpi .label{font-size:.78rem;color:var(--muted)}
    .kpi .value{font-size:1.1rem;font-variant-numeric:tabular-nums}
    .cons-box{margin-bottom:10px;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220}
    .cons-title{font-size:.92rem;margin-bottom:6px;color:#cbd5e1}
    .cons-value{font-size:1.6rem;font-weight:700;letter-spacing:.2px}
    .cons-sub{font-size:.82rem;color:#9aa9bb;margin-top:6px;line-height:1.35}

    .cons-trio{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:900px){.cons-trio{grid-template-columns:1fr}}
    .cons-tile{background:#0b1220;border:1px solid #334155;border-radius:10px;padding:12px}
    .cons-tile .cons-title{margin-bottom:6px}
    .cons-tile .cons-value{font-size:1.6rem;font-weight:700;letter-spacing:.2px}
    .cons-tile .subline{margin-top:6px;font-size:.82rem;color:#9aa9bb;line-height:1.35}
    .cons-tile.hidden{display:none}
    .tile-ok{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.10)}
    .tile-warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.10)}
    .tile-bad{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.10)}

    canvas{width:100%;height:380px;background:#0b1220;border-radius:12px;border:1px solid #334155}
    .footer{margin-top:10px;font-size:.8rem;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #374151}
    .delta{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid #334155;font-size:.8rem}
    .delta.ok{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#bbf7d0}
    .delta.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
    .delta.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fecaca}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <h1>
    <span class="titlewrap">
      <div class="brand" aria-label="EES3 Logo">
        <svg viewBox="0 0 64 64" role="img" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="var(--accent)"/>
              <stop offset="1" stop-color="var(--accent2)"/>
            </linearGradient>
          </defs>
          <path d="M32 4 54 16v32L32 60 10 48V16L32 4Z" fill="none" stroke="url(#g)" stroke-width="3.2" />
          <path d="M30 14 18 36h12l-2 14 18-26H34l-4-10Z" fill="url(#g)" opacity=".85"/>
        </svg>
        <div class="brandcaption">EES3 by Rafael Wojczik</div>
      </div>
      <span class="title">Fahrwiderstands- & Verbrauchsrechner</span>
    </span>
    <span class="toolbar">
      <span class="badge">EV &amp; ICE</span>
    </span>
  </h1>

  <div class="layout">
    <!-- Eingaben -->
    <div class="card">
      <div class="inputs">
        <div class="wide">
          <label for="klasse">Fahrzeugklasse (Voreinstellungen)</label>
          <select id="klasse">
            <option value="kompakt">Kompaktklasse (EV) – Standard</option>
            <option value="klein">Kleinwagen (EV)</option>
            <option value="mittel">Mittelklasse (EV)</option>
            <option value="suv">SUV (EV)</option>
            <option value="transporter">Transporter (EV)</option>
            <option value="sport">Sportwagen (EV)</option>
            <option value="macan_4s">Porsche Macan 4S Electric</option>
            <option value="macan_turbo">Porsche Macan Turbo Electric</option>
            <option value="cayenne_e">Porsche Cayenne Electric (Schätzung)</option>
            <option value="boxster_e">Porsche Boxster Electric (Schätzung)</option>
            <option value="custom">Benutzerdefiniert</option>
          </select>
        </div>

        <div>
          <label for="antriebArt">Antriebsart / Kraftstoff</label>
          <select id="antriebArt">
            <option value="ev">Elektrofahrzeug</option>
            <option value="benzin">Verbrenner – Benzin</option>
            <option value="diesel">Verbrenner – Diesel</option>
          </select>
        </div>

        <div>
          <label for="drivetrain">Antriebskonfiguration</label>
          <select id="drivetrain">
            <option value="2wd">2WD (η Drivetrain = 0,92)</option>
            <option value="4wd">4WD (η Drivetrain = 0,88)</option>
          </select>
        </div>

        <div>
          <label for="cw">cw-Wert</label>
          <input type="number" id="cw" step="0.01" min="0.1" max="1.0" />
        </div>

        <div>
          <label for="A">Stirnfläche A [m²]</label>
          <input type="number" id="A" step="0.01" min="1.0" max="5.0" />
        </div>

        <div>
          <label for="v">Geschwindigkeit v (Durchschnitt) [km/h]</label>
          <input type="number" id="v" step="1" min="1" max="300" />
        </div>

        <div>
          <label for="vmax">Höchstgeschwindigkeit (max.) [km/h]</label>
          <input type="number" id="vmax" step="1" min="40" max="320" />
        </div>

        <div>
          <label for="dist">Strecke s [km]</label>
          <input type="number" id="dist" step="1" min="1" max="2000" />
        </div>

        <div>
          <label for="tempC">Außentemperatur T [°C]</label>
          <input type="number" id="tempC" step="1" min="-25" max="45" />
        </div>

        <div>
          <label for="mLeer">Fahrzeugmasse leer [kg]</label>
          <input type="number" id="mLeer" step="10" min="500" max="4500" />
        </div>

        <div>
          <label for="nPers">Anzahl Personen</label>
          <input type="number" id="nPers" step="1" min="0" max="9" />
        </div>

        <div>
          <label for="fStyle">Fahrweise (Stil-Faktor)</label>
          <select id="fStyle">
            <option value="1.00">Eco / Ruhig (×1,00)</option>
            <option value="1.10">Normal (×1,10)</option>
            <option value="1.25">Sportlich (×1,25)</option>
          </select>
        </div>

        <div>
          <label for="fTraffic">Verkehrssituation (Verbrauchsfaktor)</label>
          <select id="fTraffic">
            <option value="1.00">freie Fahrt (Urlaubsfahrt) – ×1,00</option>
            <option value="1.05">wenig Verkehr – ×1,05</option>
            <option value="1.15">mittlerer Verkehr – ×1,15</option>
            <option value="1.35">hoher Verkehr – ×1,35</option>
            <option value="1.70">Stau / Stop-and-Go – ×1,70</option>
          </select>
        </div>

        <div class="wide">
          <label id="lblTripActual" for="tripActual">Optional: gemessener Trip-Verbrauch (Gesamt) [kWh oder L]</label>
          <input type="number" id="tripActual" step="0.1" min="0" />
        </div>
      </div>

      <p class="footer">
        Auswahl füllt cw/A/Masse/Drivetrain/vmax vor. Bei "Benutzerdefiniert" bleibt alles editierbar.
      </p>
    </div>

    <!-- Ergebnisse -->
    <div class="card">
      <div class="cons-box">
        <div class="cons-trio">
          <div class="cons-tile" id="tileMain">
            <div class="cons-title" id="consTitle">Verbrauch (Trip)</div>
            <div class="cons-value mono" id="consMain">–</div>
            <div class="subline">
              Basis (ohne Verkehr/Fahrweise): <span class="mono" id="consBase">–</span><br/>
              Fahrzeit: <span class="mono" id="tripTime">–</span> ·
              Peak-Faktor (vmax/v): <span class="mono" id="peakOut">–</span> ·
              ρ(T): <span class="mono" id="rhoOut">–</span>
            </div>
          </div>

          <div class="cons-tile hidden" id="tileEqGas">
            <div class="cons-title">Äquivalent Benzin</div>
            <div class="cons-value mono" id="eqGasMain">–</div>
            <div class="subline">L/100 km: <span class="mono" id="eqGasL100">–</span></div>
          </div>

          <div class="cons-tile hidden" id="tileEqDiesel">
            <div class="cons-title">Äquivalent Diesel</div>
            <div class="cons-value mono" id="eqDieselMain">–</div>
            <div class="subline">L/100 km: <span class="mono" id="eqDieselL100">–</span></div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;justify-content:flex-end">
          <div id="deltaWrap" style="display:none;">
            <span class="delta" id="deltaBadge">Δ –</span>
          </div>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="label">Gesamtmasse m<sub>gesamt</sub> [kg]</div><div class="value mono" id="mGesOut">–</div></div>
        <div class="kpi"><div class="label">Luftwiderstand F<sub>Luft</sub> [N]</div><div class="value mono" id="fLuftOut">–</div></div>
        <div class="kpi"><div class="label">Rollwiderstand F<sub>Roll</sub> [N]</div><div class="value mono" id="fRollOut">–</div></div>
        <div class="kpi"><div class="label">Gesamt F<sub>ges</sub> [N]</div><div class="value mono" id="fGesOut">–</div></div>
        <div class="kpi"><div class="label">Radleistung P<sub>Rad</sub> [kW]</div><div class="value mono" id="pRadOut">–</div></div>
        <div class="kpi"><div class="label">Motorleistung P<sub>Motor</sub> [kW]</div><div class="value mono" id="pMotorOut">–</div></div>
      </div>

      <div style="margin-top:12px;">
        <span class="pill mono" id="bpText">Betriebspunkt: –</span>
      </div>

      <div style="margin-top:12px;">
        <canvas id="chart"></canvas>
      </div>

      <div class="footer">
        EV/ICE sind Näherungen: temperaturabhängige Nebenverbraucher, lastabhängige Wirkungsgrade und Stop-Anteile werden grob berücksichtigt.
      </div>
    </div>
  </div>

<script>
/* ===== Physik / Parameter ===== */
const g=9.81, c_r=0.012;
const eta_2wd=0.92, eta_4wd=0.88;
const hv_benzin=8.9, hv_diesel=9.8;

/* ===== Presets ===== */
const presets = {
  klein:       { cw:0.32, A:2.05, m:1400, dt:'2wd', vmax:150 },
  kompakt:     { cw:0.29, A:2.20, m:1700, dt:'2wd', vmax:160 },
  mittel:      { cw:0.28, A:2.30, m:1900, dt:'2wd', vmax:180 },
  suv:         { cw:0.30, A:2.70, m:2200, dt:'4wd', vmax:180 },
  transporter: { cw:0.42, A:3.10, m:2600, dt:'2wd', vmax:140 },
  sport:       { cw:0.25, A:2.00, m:1900, dt:'2wd', vmax:250 },
  macan_4s:    { cw:0.25, A:2.69, m:2345, dt:'4wd', vmax:240 },
  macan_turbo: { cw:0.25, A:2.68, m:2405, dt:'4wd', vmax:260 },
  cayenne_e:   { cw:0.25, A:2.83, m:2600, dt:'4wd', vmax:230 },
  boxster_e:   { cw:0.30, A:1.98, m:1750, dt:'2wd', vmax:240 },
  custom: null
};

/* ===== DOM ===== */
const el = {
  klasse: document.getElementById('klasse'),
  antriebArt: document.getElementById('antriebArt'),
  drivetrain: document.getElementById('drivetrain'),
  cw: document.getElementById('cw'),
  A: document.getElementById('A'),
  v: document.getElementById('v'),
  vmax: document.getElementById('vmax'),
  dist: document.getElementById('dist'),
  tempC: document.getElementById('tempC'),
  mLeer: document.getElementById('mLeer'),
  nPers: document.getElementById('nPers'),
  fStyle: document.getElementById('fStyle'),
  fTraffic: document.getElementById('fTraffic'),
  tripActual: document.getElementById('tripActual'),
  lblTripActual: document.getElementById('lblTripActual'),

  consTitle: document.getElementById('consTitle'),
  consMain: document.getElementById('consMain'),
  consBase: document.getElementById('consBase'),
  tripTime: document.getElementById('tripTime'),
  peakOut: document.getElementById('peakOut'),
  rhoOut: document.getElementById('rhoOut'),

  tileMain: document.getElementById('tileMain'),
  tileEqGas: document.getElementById('tileEqGas'),
  tileEqDiesel: document.getElementById('tileEqDiesel'),
  eqGasMain: document.getElementById('eqGasMain'),
  eqDieselMain: document.getElementById('eqDieselMain'),
  eqGasL100: document.getElementById('eqGasL100'),
  eqDieselL100: document.getElementById('eqDieselL100'),

  deltaWrap: document.getElementById('deltaWrap'),
  deltaBadge: document.getElementById('deltaBadge'),

  mGesOut: document.getElementById('mGesOut'),
  fLuftOut: document.getElementById('fLuftOut'),
  fRollOut: document.getElementById('fRollOut'),
  fGesOut: document.getElementById('fGesOut'),
  pRadOut: document.getElementById('pRadOut'),
  pMotorOut: document.getElementById('pMotorOut'),

  bpText: document.getElementById('bpText'),
  chart: document.getElementById('chart')
};

/* ===== Helpers ===== */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function num(inp, fallback, min=-Infinity, max=Infinity){
  const x = Number(inp.value);
  if (!Number.isFinite(x)) return fallback;
  return clamp(x, min, max);
}
function fmt(x, d=2){
  if (!Number.isFinite(x)) return '–';
  return new Intl.NumberFormat('de-DE',{minimumFractionDigits:d, maximumFractionDigits:d}).format(x);
}
function fmt0(x){ return fmt(x,0); }
function drivetrainEta(){ return el.drivetrain.value === '4wd' ? eta_4wd : eta_2wd; }

// Farblogik (auf L/100 km): Benzin >10 orange, >12 rot; Diesel -2 => >8 orange, >10 rot
function toneByL100(tileEl, l100, isDiesel=false){
  tileEl.classList.remove('tile-ok','tile-warn','tile-bad');
  const warn = isDiesel ? 8 : 10;
  const bad  = isDiesel ? 10 : 12;
  if (!Number.isFinite(l100)) return;
  if (l100 > bad) tileEl.classList.add('tile-bad');
  else if (l100 > warn) tileEl.classList.add('tile-warn');
  else tileEl.classList.add('tile-ok');
}


/* ===== Realismus ===== */
function airDensityFromTemp(tempC){
  const T = tempC + 273.15, T0 = 288.15;
  return 1.225 * (T0 / T);
}
function peakFactor(vavg, vmax){
  const r = Math.max(1, vmax / Math.max(1, vavg));
  return 1 + Math.min(0.35, 0.18*(r-1));
}
function etaEV(p_kW){
  if (p_kW < 8)   return 0.78;
  if (p_kW < 25)  return 0.86;
  if (p_kW < 90)  return 0.91;
  if (p_kW < 160) return 0.89;
  return 0.86;
}
function pAuxEV(tempC){
  if (tempC <= -10) return 5.0;
  if (tempC <= 0)   return 3.5;
  if (tempC <= 10)  return 2.2;
  if (tempC <= 25)  return 1.2;
  if (tempC <= 35)  return 1.8;
  return 2.4;
}
function etaICE(p_kW){
  if (p_kW < 8)   return 0.12;
  if (p_kW < 25)  return 0.18;
  if (p_kW < 70)  return 0.26;
  if (p_kW < 140) return 0.24;
  return 0.21;
}
function stopFracFromTraffic(fTraffic){
  if (fTraffic <= 1.00) return 0.00;
  if (fTraffic <= 1.05) return 0.06;
  if (fTraffic <= 1.15) return 0.14;
  if (fTraffic <= 1.35) return 0.28;
  return 0.48;
}
function idle_Lph(fuel){ return (fuel === 'diesel') ? 0.7 : 0.9; }
function trafficFactorEV(fTraffic){ return 1 + (fTraffic - 1)*0.55; }

/* ===== Preset anwenden (und wirklich in Inputs schreiben) ===== */
function setPreset(name, force=false){
  const p = presets[name];
  if (!p) return;
  el.cw.value = String(p.cw);
  el.A.value = String(p.A);
  el.mLeer.value = String(p.m);
  el.drivetrain.value = p.dt;
  el.vmax.value = String(p.vmax);

  // v / dist / temp setzen (bei Init/Wechsel erzwingen)
  if (force || !el.v.value)     el.v.value     = String(Math.min(110, p.vmax));
  if (force || !el.dist.value)  el.dist.value  = "100";
  if (force || !el.tempC.value) el.tempC.value = "15";
}

/* ===== Deviation badge ===== */
function updateDeviation(actual, predicted, unit){
  if (!Number.isFinite(actual) || actual <= 0 || !Number.isFinite(predicted) || predicted <= 0){
    el.deltaWrap.style.display = 'none';
    return;
  }
  const dev = (actual - predicted) / predicted * 100;
  const absDev = Math.abs(dev);
  let cls = 'ok';
  if (absDev > 20) cls = 'bad';
  else if (absDev >= 10) cls = 'warn';

  el.deltaWrap.style.display = 'block';
  el.deltaBadge.className = 'delta ' + cls;
  const sign = dev >= 0 ? '+' : '−';
  el.deltaBadge.textContent = `Δ ${sign}${fmt(absDev,1)}%`;
  el.deltaBadge.title = `Gemessen: ${fmt(actual,2)} ${unit} · Prognose: ${fmt(predicted,2)} ${unit}`;
}

/* ===== Canvas ===== */
function resizeCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(2, Math.round(rect.width * dpr));
  canvas.height = Math.max(2, Math.round(rect.height * dpr));
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, W: rect.width, H: rect.height};
}

function drawChart(cw, A, mGes, eta_dt, vmax, vavg, rhoT){
  const {ctx, W, H} = resizeCanvas(el.chart);
  ctx.clearRect(0,0,W,H);

  const pad = {left:60,right:20,top:20,bottom:40};
  const w = W - pad.left - pad.right;
  const h = H - pad.top - pad.bottom;

  const N = Math.max(60, Math.floor(vmax));
  const xs=[], ys=[]; let yMax = 0;

  for(let i=0;i<=N;i++){
    const v_kmh_i = i*(vmax/N), v_ms_i = v_kmh_i/3.6;
    const fLuft_i = 0.5*rhoT*cw*A*v_ms_i*v_ms_i;
    const fRoll_i = c_r*mGes*g;
    const pMotor_i = (fLuft_i+fRoll_i)*v_ms_i/1000.0/(eta_dt || eta_2wd);
    xs.push(v_kmh_i); ys.push(pMotor_i); if (pMotor_i>yMax) yMax=pMotor_i;
  }
  yMax = Math.max(yMax,20)*1.10;

  const xToPx = x => pad.left + (x/vmax)*w;
  const yToPx = y => pad.top + h - (y/yMax)*h;

  ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
  ctx.beginPath();
  for(let gx=0;gx<=10;gx++){ const x=pad.left+(gx/10)*w; ctx.moveTo(x,pad.top); ctx.lineTo(x,pad.top+h); }
  for(let gy=0;gy<=8;gy++){ const y=pad.top+(gy/8)*h; ctx.moveTo(pad.left,y); ctx.lineTo(pad.left+w,y); }
  ctx.stroke();

  ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(pad.left,pad.top+h); ctx.lineTo(pad.left+w,pad.top+h);
  ctx.moveTo(pad.left,pad.top); ctx.lineTo(pad.left,pad.top+h);
  ctx.stroke();

  ctx.fillStyle = '#94a3b8'; ctx.font = '12px system-ui';
  ctx.fillText('Geschwindigkeit v [km/h]', pad.left + w/2 - 75, pad.top + h + 28);
  ctx.save(); ctx.translate(16, pad.top + h/2 + 40); ctx.rotate(-Math.PI/2);
  ctx.fillText('Motorleistung P [kW]', 0, 0); ctx.restore();

  ctx.fillStyle = '#cbd5e1'; ctx.font = '11px system-ui';
  for (let gx=0; gx<=10; gx++){
    const xVal = Math.round((gx/10) * vmax);
    ctx.fillText(String(xVal), xToPx(xVal)-8, pad.top+h+16);
  }
  for (let gy=0; gy<=8; gy++){
    const yVal = Math.round((gy/8) * yMax);
    ctx.fillText(String(yVal), pad.left-40, yToPx(yVal)+4);
  }

  ctx.strokeStyle = 'rgba(34,211,238,0.9)'; ctx.lineWidth = 2.2;
  ctx.beginPath();
  for (let i=0;i<xs.length;i++){
    const x = xToPx(xs[i]), y = yToPx(ys[i]);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  const v_ms = vavg/3.6;
  const fLuft = 0.5*rhoT*cw*A*v_ms*v_ms;
  const fRoll = c_r*mGes*g;
  const pMotor = (fLuft+fRoll)*v_ms/1000.0/(eta_dt || eta_2wd);

  const xPt = xToPx(vavg), yPt = yToPx(pMotor);
  ctx.fillStyle = '#a78bfa'; ctx.strokeStyle = '#a78bfa';
  ctx.beginPath(); ctx.arc(xPt,yPt,4.5,0,Math.PI*2); ctx.fill();
}

/* ===== Compute ===== */
function compute(){
  const cw = num(el.cw, 0.29, 0.10, 1.00);
  const A  = num(el.A,  2.20, 1.00, 5.00);
  const vavg = num(el.v, 100, 1, 300);
  const vmax = num(el.vmax, 160, 40, 320);
  const dist = num(el.dist, 100, 1, 2000);
  const tempC = num(el.tempC, 15, -25, 45);
  const mLeer = num(el.mLeer, 1700, 500, 4500);
  const nPers = Math.round(num(el.nPers, 1, 0, 9));
  const eta_dt = drivetrainEta();
  const fTraffic = num(el.fTraffic, 1.00, 1.0, 2.0);
  const fStyle   = num(el.fStyle,   1.10, 1.0, 2.0);

  const mGes = mLeer + 80*nPers;
  const rhoT = airDensityFromTemp(tempC);

  const v_ms = vavg/3.6;
  const fLuft = 0.5*rhoT*cw*A*v_ms*v_ms;
  const fRoll = c_r*mGes*g;
  const fGes = fLuft + fRoll;

  const pRad = fGes*v_ms/1000.0;
  const pMotor = pRad/eta_dt;

  const t_h = dist / vavg;
  const t100_h = 100.0 / vavg;

  const fPeak = peakFactor(vavg, vmax);

  el.mGesOut.textContent = fmt0(mGes);
  el.fLuftOut.textContent = fmt(fLuft,1);
  el.fRollOut.textContent = fmt(fRoll,1);
  el.fGesOut.textContent = fmt(fGes,1);
  el.pRadOut.textContent = fmt(pRad,1);
  el.pMotorOut.textContent = fmt(pMotor,1);
  el.tripTime.textContent = `${fmt(t_h,2)} h`;
  el.peakOut.textContent = fmt(fPeak,2);
  el.rhoOut.textContent = `${fmt(rhoT,3)} kg/m³`;
  el.bpText.textContent = `Betriebspunkt: ${fmt0(vavg)} km/h — P = ${fmt(pMotor,1)} kW`;

  const actual = Number(el.tripActual.value);
  const actualValid = Number.isFinite(actual) && actual > 0;

  
  // Äquivalente Verbrenner-Verbräuche immer berechnen und anzeigen (Sensibilisierung)
  el.tileEqGas.classList.remove('hidden');
  el.tileEqDiesel.classList.remove('hidden');

  function iceConsumption(fuel){
    const hv = (fuel === 'diesel') ? hv_diesel : hv_benzin;
    const eta_ice = etaICE(pMotor*fPeak);
    const eChem100_base = ((pMotor*fPeak)/eta_ice) * t100_h;
    const l100_base = eChem100_base / hv;

    const stopFrac = stopFracFromTraffic(fTraffic);
    const idleExtra_L_100 = idle_Lph(fuel) * (t_h * stopFrac) * (100.0/dist);

    const l100_corr = (l100_base * fTraffic * fStyle) + idleExtra_L_100;
    const lTrip = l100_corr * (dist/100.0);
    return { l100_base, l100_corr, lTrip };
  }

  const eqGas = iceConsumption('benzin');
  const eqDiesel = iceConsumption('diesel');

  el.eqGasMain.textContent = `${fmt(eqGas.lTrip,2)} L`;
  el.eqGasL100.textContent = fmt(eqGas.l100_corr,2);

  el.eqDieselMain.textContent = `${fmt(eqDiesel.lTrip,2)} L`;
  el.eqDieselL100.textContent = fmt(eqDiesel.l100_corr,2);

  toneByL100(el.tileEqGas, eqGas.l100_corr, false);
  toneByL100(el.tileEqDiesel, eqDiesel.l100_corr, true);

if (el.antriebArt.value === 'ev'){
    el.lblTripActual.textContent = 'Optional: gemessener Trip-Verbrauch (Gesamt) [kWh]';

    const eta_ev = etaEV(pMotor*fPeak);
    const e100_base = ((pMotor*fPeak)/eta_ev + pAuxEV(tempC)) * t100_h;
    const e100_corr = e100_base * trafficFactorEV(fTraffic) * fStyle;
    const eTrip = e100_corr * (dist/100.0);

    el.consTitle.textContent = 'Verbrauch (Trip, EV)';
    el.consMain.textContent  = `${fmt(eTrip,2)} kWh`;
    el.consBase.textContent  = `${fmt(e100_base,2)} kWh/100 km`;
    updateDeviation(actualValid ? actual : NaN, eTrip, 'kWh');
  } else {
    const fuel = el.antriebArt.value; // benzin|diesel
    const hv = (fuel === 'diesel') ? hv_diesel : hv_benzin;

    el.lblTripActual.textContent = 'Optional: gemessener Trip-Verbrauch (Gesamt) [L]';

    const eta_ice = etaICE(pMotor*fPeak);
    const eChem100_base = ((pMotor*fPeak)/eta_ice) * t100_h;
    const l100_base = eChem100_base / hv;

    const stopFrac = stopFracFromTraffic(fTraffic);
    const idleExtra_L_100 = idle_Lph(fuel) * (t_h * stopFrac) * (100.0/dist);

    const l100_corr = (l100_base * fTraffic * fStyle) + idleExtra_L_100;
    const lTrip = l100_corr * (dist/100.0);

    el.consTitle.textContent = `Verbrauch (Trip, ${fuel === 'diesel' ? 'Diesel' : 'Benzin'})`;
    el.consMain.textContent  = `${fmt(lTrip,2)} L`;
    el.consBase.textContent  = `${fmt(l100_base,2)} L/100 km`;
    updateDeviation(actualValid ? actual : NaN, lTrip, 'L');
  }

  drawChart(cw, A, mGes, eta_dt, vmax, vavg, rhoT);
}

/* ===== Events ===== */
let tmr=0;
function scheduleCompute(){ clearTimeout(tmr); tmr=setTimeout(compute, 20); }

['input','change'].forEach(evt=>{
  ['klasse','antriebArt','drivetrain','cw','A','v','vmax','dist','tempC','mLeer','nPers','fStyle','fTraffic','tripActual']
    .forEach(id => document.getElementById(id).addEventListener(evt, scheduleCompute));
});

el.klasse.addEventListener('change', ()=>{
  const k = el.klasse.value;
  if (k !== 'custom') setPreset(k, true);
  scheduleCompute();
});

window.addEventListener('resize', scheduleCompute);

/* ===== Init ===== */
function init(){
  el.klasse.value='kompakt';
  el.antriebArt.value='ev';
  el.nPers.value='1';
  el.v.value='100';
  el.dist.value='100';
  el.tempC.value='15';
  el.fTraffic.value='1.00';
  el.fStyle.value='1.10';
  setPreset('kompakt', true);
  compute();
}
init();
</script>
</body>
</html>

<meta name="wb:op" content="0123680dfd01271da4ec97685a7b2b6b"/>
